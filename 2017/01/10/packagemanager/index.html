<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="tAZFMfKLyroTOSdyRn-N_-NNj4LWJk_LNcOAbASRlso" />




  <meta name="baidu-site-verification" content="KDQ5UD1bGz" />







  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="PMS,PackageManager,PackageManagerService," />





  <link rel="alternate" href="/atom.xml" title="风中老狼的博客" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="本文介绍PackageManagerService启动流程。">
<meta property="og:type" content="article">
<meta property="og:title" content="PackageManagerService启动流程">
<meta property="og:url" content="https://maoao530.github.io/2017/01/10/packagemanager/index.html">
<meta property="og:site_name" content="风中老狼的博客">
<meta property="og:description" content="本文介绍PackageManagerService启动流程。">
<meta property="og:updated_time" content="2017-01-17T14:26:02.647Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PackageManagerService启动流程">
<meta name="twitter:description" content="本文介绍PackageManagerService启动流程。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> PackageManagerService启动流程 | 风中老狼的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">风中老狼的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">不积跬步，无以至千里；不积小流，无以成江海</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                PackageManagerService启动流程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-10T22:04:59+08:00" content="2017-01-10">
              2017-01-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android进阶/" itemprop="url" rel="index">
                    <span itemprop="name">Android进阶</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/10/packagemanager/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/10/packagemanager/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文介绍PackageManagerService启动流程。</p>
<a id="more"></a>
<p>相关源码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</div><div class="line">frameworks/base/services/core/java/com/android/server/pm/PackageInstallerService.java</div><div class="line">frameworks/base/services/core/java/com/android/server/pm/Settings.java</div><div class="line">frameworks/base/services/core/java/com/android/server/pm/Installer.java</div><div class="line">frameworks/base/services/core/java/com/android/server/SystemConfig.java</div><div class="line"></div><div class="line">frameworks/base/core/java/android/content/pm/PackageManager.java</div><div class="line">frameworks/base/core/java/android/content/pm/IPackageManager.aidl</div><div class="line">frameworks/base/core/java/android/content/pm/PackageParser.java</div><div class="line"></div><div class="line">frameworks/base/core/java/com/android/internal/os/InstallerConnection.java</div><div class="line">frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java</div></pre></td></tr></table></figure></p>
<h1 id="system-server启动PMS"><a href="#system-server启动PMS" class="headerlink" title="system_server启动PMS"></a>system_server启动PMS</h1><p>Android的所有Java服务都是通过<code>system_server</code>进程启动的，并且驻留在<code>system_server</code>进程中。SystemServer进程在启动时，通过创建一个<code>ServerThread</code>线程来启动所有服务，现在先来看看Android服务中<code>PackageManagerService</code>服务启动过程。</p>
<blockquote>
<p>/frameworks/base/services/java/com/android/server/SystemServer.java</p>
</blockquote>
<h2 id="startBootstrapServices"><a href="#startBootstrapServices" class="headerlink" title="startBootstrapServices()"></a>startBootstrapServices()</h2><p>system_server的<strong><code>startBootstrapServices()</code></strong>函数会启动一些引导服务，该方法所创建的服务：</p>
<ul>
<li>ActivityManagerService, </li>
<li>PowerManagerService, </li>
<li>LightsService, </li>
<li>DisplayManagerService， </li>
<li><code>PackageManagerService</code>，</li>
<li>UserManagerService， </li>
<li>SensorService服务。</li>
</ul>
<p>其中我们需要的PackageManagerService就在这里启动，我们来看看startBootstrapServices()是如何启动PMS的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//启动installer服务</span></div><div class="line">        Installer installer = mSystemServiceManager.startService(Installer.class);</div><div class="line"></div><div class="line">        <span class="comment">// We need the default display before we can initialize the package manager.</span></div><div class="line">        mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</div><div class="line">        </div><div class="line">        <span class="comment">//处于加密状态则仅仅解析核心应用</span></div><div class="line">        <span class="comment">// Only run "core" apps if we're encrypting the device.</span></div><div class="line">        String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</div><div class="line">        <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Detected encryption in progress - only parsing core apps"</span>);</div><div class="line">            mOnlyCore = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Device encrypted - only parsing core apps"</span>);</div><div class="line">            mOnlyCore = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 创建PMS对象 - 启动入口</span></div><div class="line">        traceBeginAndSlog(<span class="string">"StartPackageManagerService"</span>);</div><div class="line">        mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</div><div class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</div><div class="line">        <span class="comment">// 是否首次启动</span></div><div class="line">        mFirstBoot = mPackageManagerService.isFirstBoot();</div><div class="line">        </div><div class="line">        <span class="comment">// 获取PackageManager</span></div><div class="line">        mPackageManager = mSystemContext.getPackageManager();</div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="startOtherServices"><a href="#startOtherServices" class="headerlink" title="startOtherServices()"></a>startOtherServices()</h2><p>另外，system_server的<code>startOtherServices()</code>方法会启动其他服务，这个函数也会对PMS作一些操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</div><div class="line">    ......</div><div class="line">    <span class="keyword">if</span> (!mOnlyCore) &#123;</div><div class="line">        ........</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//将调用performDexOpt:Performs dexopt on the set of packages</span></div><div class="line">            mPackageManagerService.updatePackagesIfNeeded();</div><div class="line">        &#125;.......</div><div class="line">        ........</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//执行Fstrim，执行磁盘维护操作，未看到详细的资料</span></div><div class="line">            <span class="comment">//可能类似于TRIM技术，将标记为删除的文件，彻底从硬盘上移除</span></div><div class="line">            <span class="comment">//而不是等到写入时再移除，目的是提高写入时效率</span></div><div class="line">            mPackageManagerService.performFstrimIfNeeded();</div><div class="line">        &#125;.........</div><div class="line">        .......</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mPackageManagerService.systemReady();</div><div class="line">        &#125;........</div><div class="line">        .......</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码可以看出，PMS启动后将参与一些系统优化的工作，然后调用SystemReady函数通知系统进入就绪状态。</p>
<p>整个system_server进程启动过程，涉及PMS服务的主要几个动作如下:</p>
<ul>
<li>PMS.main()</li>
<li>PMS.performDexOpt()</li>
<li>PMS.systemReady()</li>
</ul>
<p>本文主要介绍PMS.main()流程，即PackageManagerService启动流程。</p>
<h1 id="PMS-main入口"><a href="#PMS-main入口" class="headerlink" title="PMS.main入口"></a>PMS.main入口</h1><p>PackageManagerService.main过程主要是创建PMS服务，并注册到ServiceManager大管家：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></div><div class="line">            <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore) &#123;</div><div class="line">        <span class="comment">// Self-check for initial settings.</span></div><div class="line">        PackageManagerServiceCompilerMapping.checkProperties();</div><div class="line"></div><div class="line">        <span class="comment">// 创建PMS对象</span></div><div class="line">        PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</div><div class="line">                factoryTest, onlyCore);</div><div class="line">        m.enableSystemUserPackages();</div><div class="line">        <span class="comment">// Disable any carrier apps. We do this very early in boot to prevent the apps from being</span></div><div class="line">        <span class="comment">// disabled after already being started.</span></div><div class="line">        CarrierAppUtils.disableCarrierAppsUntilPrivileged(context.getOpPackageName(), m,</div><div class="line">                UserHandle.USER_SYSTEM);</div><div class="line">        </div><div class="line">        <span class="comment">// 添加到ServiceManager</span></div><div class="line">        ServiceManager.addService(<span class="string">"package"</span>, m);</div><div class="line">        <span class="keyword">return</span> m;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="PMS构造函数-分析"><a href="#PMS构造函数-分析" class="headerlink" title="PMS构造函数 - 分析"></a>PMS构造函数 - 分析</h1><blockquote>
<p>new PackageManagerService(context, installer, factoryTest, onlyCore);</p>
</blockquote>
<p>创建PMS对象的过程，就是执行PMS的构造函数，PMS构造函数比较长，我们把这个过程分成几个阶段：</p>
<ul>
<li>BOOT_PROGRESS_PMS_START,</li>
<li>BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</li>
<li>BOOT_PROGRESS_PMS_DATA_SCAN_START,</li>
<li>BOOT_PROGRESS_PMS_SCAN_END,</li>
<li>BOOT_PROGRESS_PMS_READY,</li>
</ul>
<p>PMS构造函数里面，在每个阶段开始的时候，都会往<code>Eventlog</code>里面打Tag，比如像这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START, SystemClock.uptimeMillis());</div></pre></td></tr></table></figure>
<p>接下来分别说说这几个阶段。</p>
<h2 id="PMS-START"><a href="#PMS-START" class="headerlink" title="PMS_START"></a>PMS_START</h2><p>BOOT_PROGRESS_PMS_START阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 输出event log</span></div><div class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</div><div class="line">        SystemClock.uptimeMillis());</div><div class="line"></div><div class="line"><span class="comment">/** M: Mtprof tool @&#123; */</span></div><div class="line"><span class="comment">//mMTPROFDisable = "1".equals(SystemProperties.get("ro.mtprof.disable"));</span></div><div class="line">mMTPROFDisable = <span class="keyword">false</span>;</div><div class="line">addBootEvent(<span class="string">"Android:PackageManagerService_Start"</span>);</div><div class="line"><span class="comment">/** @&#125; */</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</div><div class="line">    Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">mContext = context;</div><div class="line">mFactoryTest = factoryTest;</div><div class="line">mOnlyCore = onlyCore;</div><div class="line"></div><div class="line"><span class="comment">// DisplayMetrics是一个描述界面显示，尺寸，分辨率，密度的类。</span></div><div class="line">mMetrics = <span class="keyword">new</span> DisplayMetrics();</div><div class="line"></div><div class="line"><span class="comment">// Settings是Android的全局管理者，用于协助PMS保存所有的安装包信息</span></div><div class="line">mSettings = <span class="keyword">new</span> Settings(mPackages);</div><div class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</div><div class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</div><div class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</div><div class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</div><div class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</div><div class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</div><div class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</div><div class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</div><div class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</div><div class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</div><div class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</div><div class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</div><div class="line"></div><div class="line"><span class="comment">// 获取debug.separate_processes属性</span></div><div class="line"><span class="comment">// 如果设置了这个属性，那么会强制应用程序组件在自己的进程中运行。</span></div><div class="line"><span class="comment">// 一般情况下不会设置这个属性</span></div><div class="line">String separateProcesses = SystemProperties.get(<span class="string">"debug.separate_processes"</span>);</div><div class="line"><span class="keyword">if</span> (separateProcesses != <span class="keyword">null</span> &amp;&amp; separateProcesses.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">// 所有process都设置这个属性</span></div><div class="line">    <span class="keyword">if</span> (<span class="string">"*"</span>.equals(separateProcesses)) &#123;</div><div class="line">        mDefParseFlags = PackageParser.PARSE_IGNORE_PROCESSES;</div><div class="line">        mSeparateProcesses = <span class="keyword">null</span>;</div><div class="line">        Slog.w(TAG, <span class="string">"Running with debug.separate_processes: * (ALL)"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 个别的process设置这个属性 </span></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        mDefParseFlags = <span class="number">0</span>;</div><div class="line">        mSeparateProcesses = separateProcesses.split(<span class="string">","</span>);</div><div class="line">        Slog.w(TAG, <span class="string">"Running with debug.separate_processes: "</span></div><div class="line">                + separateProcesses);</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 不设置这个属性,一般情况下会走这</span></div><div class="line">    mDefParseFlags = <span class="number">0</span>;</div><div class="line">    mSeparateProcesses = <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 保存Installer对象</span></div><div class="line">mInstaller = installer;</div><div class="line"></div><div class="line"><span class="comment">// //用于dex优化</span></div><div class="line">mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(installer, mInstallLock, context,</div><div class="line">        <span class="string">"*dexopt*"</span>);</div><div class="line">mMoveCallbacks = <span class="keyword">new</span> MoveCallbacks(FgThread.get().getLooper());</div><div class="line"></div><div class="line">mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</div><div class="line">        FgThread.get().getLooper());</div><div class="line"></div><div class="line"><span class="comment">// 获取默认的显示信息，保存到mMetrics</span></div><div class="line">getDefaultDisplayMetrics(context, mMetrics);</div><div class="line"></div><div class="line"><span class="comment">// 获取系统配置信息</span></div><div class="line">SystemConfig systemConfig = SystemConfig.getInstance();</div><div class="line">mGlobalGids = systemConfig.getGlobalGids();</div><div class="line">mSystemPermissions = systemConfig.getSystemPermissions();</div><div class="line">mAvailableFeatures = systemConfig.getAvailableFeatures();</div><div class="line"></div><div class="line"><span class="keyword">synchronized</span> (mInstallLock) &#123;</div><div class="line"><span class="comment">// writer</span></div><div class="line"><span class="keyword">synchronized</span> (mPackages) &#123;</div><div class="line"></div><div class="line">    <span class="comment">//创建名为“PackageManager”的handler线程</span></div><div class="line">    mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</div><div class="line">            Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</div><div class="line">    mHandlerThread.start();</div><div class="line">    </div><div class="line">    <span class="comment">// 建立PackageHandler消息循环，用于处理外部的安装请求等消息</span></div><div class="line">    <span class="comment">// 比如如adb install、packageinstaller安装APK时</span></div><div class="line">    mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</div><div class="line">    mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</div><div class="line">    Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</div><div class="line"></div><div class="line">    <span class="comment">// 创建各种目录</span></div><div class="line">    File dataDir = Environment.getDataDirectory();</div><div class="line">    mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>);</div><div class="line">    mAppLib32InstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);</div><div class="line">    mEphemeralInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-ephemeral"</span>);</div><div class="line">    mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();</div><div class="line">    mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 创建用户管理服务</span></div><div class="line">    sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>, mPackages);</div><div class="line"></div><div class="line">    <span class="comment">// Propagate permission configuration in to package manager.</span></div><div class="line">    ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</div><div class="line">            = systemConfig.getPermissions();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;permConfig.size(); i++) &#123;</div><div class="line">        SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</div><div class="line">        BasePermission bp = mSettings.mPermissions.get(perm.name);</div><div class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</div><div class="line">            bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</div><div class="line">            mSettings.mPermissions.put(perm.name, bp);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</div><div class="line">            bp.setGids(perm.gids, perm.perUser);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取共享库</span></div><div class="line">    ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</div><div class="line">        mSharedLibraries.put(libConfig.keyAt(i),</div><div class="line">                <span class="keyword">new</span> SharedLibraryEntry(libConfig.valueAt(i), <span class="keyword">null</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mFoundPolicyFile = SELinuxMMAC.readInstallPolicy();</div><div class="line"></div><div class="line">    <span class="comment">// 解析packages.xml和packages-backup.xml</span></div><div class="line">    mRestoredSettings = mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</div><div class="line"></div><div class="line">    ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们再来总结PMS_START阶段都做了什么：</p>
<p><strong>总结阶段一主要工作如下：</strong></p>
<ul>
<li>构造DisplayMetrics类：描述界面显示，尺寸，分辨率，密度。构造完后并获取默认的信息保存到变量mMetrics中。</li>
<li>构造Settings类：这个是Android的全局管理者，用于协助PMS保存所有的安装包信息</li>
<li>保存Installer对象</li>
<li>获取系统配置信息：SystemConfig构造函数中会通过<code>readPermissions()</code>解析指定目录下的所有xml文件,然后把这些信息保存到systemConfig中，涉及的目录有如下：<ul>
<li>/system/etc/sysconfig</li>
<li>/system/etc/permissions</li>
<li>/oem/etc/sysconfig</li>
<li>/oem/etc/permissions</li>
</ul>
</li>
<li>创建名为PackageManager的handler线程，建立PackageHandler消息循环，用于处理外部的安装请求等消息</li>
<li>创建data下的各种目录，比如data/app, data/app-private等。</li>
<li>创建用户管理服务UserManagerService</li>
<li>把systemConfig关于xml中的<library>标签所指的动态库保存到mSharedLibraries</library></li>
<li>Settings.readLPw扫描解析packages.xml和packages-backup.xml</li>
</ul>
<p>补充说明下<strong>debug.separate_processes</strong>这个属性：<br>这个属性你可以使用强制应用程序组件在自己的进程中运行，有两种方法可以使用这个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 所有的进程都会受到影响</div><div class="line">setprop debug.separate_processes </div><div class="line">// 指定进程受影响</div><div class="line">setprop debug.separate_processes“com.google.process.content, com.google.android.samples”</div></pre></td></tr></table></figure>
<p>这个属性一般不会用到。</p>
<h2 id="PMS-SYSTEM-SCAN-START"><a href="#PMS-SYSTEM-SCAN-START" class="headerlink" title="PMS_SYSTEM_SCAN_START"></a>PMS_SYSTEM_SCAN_START</h2><p>接下来是BOOT_PROGRESS_PMS_SYSTEM_SCAN_START阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</div><div class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</div><div class="line">        startTime);</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</div><div class="line"><span class="comment">//该集合中存放的是已经优化或者不需要优先的文件</span></div><div class="line"><span class="keyword">final</span> ArraySet&lt;String&gt; alreadyDexOpted = <span class="keyword">new</span> ArraySet&lt;String&gt;();</div><div class="line"></div><div class="line"><span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</div><div class="line"><span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</div><div class="line"></div><div class="line"><span class="comment">//将环境变量BOOTCLASSPATH所执行的文件加入alreadyDexOpted</span></div><div class="line"><span class="keyword">if</span> (bootClassPath != <span class="keyword">null</span>) &#123;</div><div class="line">    String[] bootClassPathElements = splitString(bootClassPath, <span class="string">':'</span>);</div><div class="line">    <span class="keyword">for</span> (String element : bootClassPathElements) &#123;</div><div class="line">        alreadyDexOpted.add(element);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//将环境变量SYSTEMSERVERCLASSPATH所执行的文件加入alreadyDexOpted</span></div><div class="line"><span class="keyword">if</span> (systemServerClassPath != <span class="keyword">null</span>) &#123;</div><div class="line">    String[] systemServerClassPathElements = splitString(systemServerClassPath, <span class="string">':'</span>);</div><div class="line">    <span class="keyword">for</span> (String element : systemServerClassPathElements) &#123;</div><div class="line">        alreadyDexOpted.add(element);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">//此处共享库是由SystemConfig实例化过程赋值的</span></div><div class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</div><div class="line">        <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</div><div class="line">            <span class="keyword">final</span> String lib = libEntry.path;</div><div class="line">            ...</div><div class="line">            <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(lib, dexCodeInstructionSet,</div><div class="line">                    <span class="string">"speed"</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</div><div class="line">                alreadyDexOpted.add(lib);</div><div class="line">                <span class="comment">//执行dexopt操作</span></div><div class="line">                mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</div><div class="line">                        dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//此处frameworkDir目录为/system/framework</span></div><div class="line">File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</div><div class="line"></div><div class="line"><span class="comment">//添加以下两个文件添加到已优化集合</span></div><div class="line">alreadyDexOpted.add(frameworkDir.getPath() + <span class="string">"/framework-res.apk"</span>);</div><div class="line">alreadyDexOpted.add(frameworkDir.getPath() + <span class="string">"/core-libart.jar"</span>);</div><div class="line"></div><div class="line">String[] frameworkFiles = frameworkDir.list();</div><div class="line"><span class="keyword">if</span> (frameworkFiles != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;frameworkFiles.length; i++) &#123;</div><div class="line">            File libPath = <span class="keyword">new</span> File(frameworkDir, frameworkFiles[i]);</div><div class="line">            String path = libPath.getPath();</div><div class="line">            <span class="comment">//跳过已优化集合中的文件</span></div><div class="line">            <span class="keyword">if</span> (alreadyDexOpted.contains(path)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//跳过后缀不为apk和jar的文件</span></div><div class="line">            <span class="keyword">if</span> (!path.endsWith(<span class="string">".apk"</span>) &amp;&amp; !path.endsWith(<span class="string">".jar"</span>)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(path, dexCodeInstructionSet,</div><div class="line">                    <span class="string">"speed"</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</div><div class="line">                <span class="comment">//执行dexopt操作【见小节2.2.1】</span></div><div class="line">                mInstaller.dexopt(path, Process.SYSTEM_UID, dexCodeInstructionSet,</div><div class="line">                        dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</div><div class="line">mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</div><div class="line">mPromoteSystemApps = mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (mPromoteSystemApps) &#123;</div><div class="line">    Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</div><div class="line">    <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</div><div class="line">        PackageSetting ps = pkgSettingIter.next();</div><div class="line">        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</div><div class="line">            mExistingSystemPackages.add(ps.name);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//收集供应商包名：/vendor/overlay</span></div><div class="line">File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</div><div class="line">scanDirLI(vendorOverlayDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//收集包名：/system/framework</span></div><div class="line">scanDirLI(frameworkDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">        | PackageParser.PARSE_IS_PRIVILEGED,</div><div class="line">        scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//收集私有的系统包名：/system/priv-app</span></div><div class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</div><div class="line">scanDirLI(privilegedAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">        | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//收集一般地系统包名：/system/app</span></div><div class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</div><div class="line">scanDirLI(systemAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//收集私有供应商包名：/vendor/priv-app</span></div><div class="line"><span class="keyword">final</span> File privilegedVendorAppDir = <span class="keyword">new</span> File(Environment.getVendorDirectory(), <span class="string">"priv-app"</span>);</div><div class="line">scanDirLI(privilegedVendorAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">        | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//收集所有的供应商包名：/vendor/app</span></div><div class="line">File vendorAppDir = <span class="keyword">new</span> File(Environment.getVendorDirectory(), <span class="string">"app"</span>);</div><div class="line">vendorAppDir = vendorAppDir.getCanonicalFile();</div><div class="line">scanDirLI(vendorAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//收集所有OEM包名：/oem/app</span></div><div class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</div><div class="line">scanDirLI(oemAppDir, PackageParser.PARSE_IS_SYSTEM</div><div class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="comment">//移除文件</span></div><div class="line">mInstaller.moveFiles();</div><div class="line"></div><div class="line"><span class="comment">//删除不在存在的系统包</span></div><div class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</div><div class="line">    Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</div><div class="line">    <span class="keyword">while</span> (psit.hasNext()) &#123;</div><div class="line">        PackageSetting ps = psit.next();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</div><div class="line">        <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</div><div class="line">                removePackageLI(ps, <span class="keyword">true</span>);</div><div class="line">                mExpectingBetter.put(ps.name, ps.codePath);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</div><div class="line">            psit.remove();</div><div class="line">            removeDataDirsLI(<span class="keyword">null</span>, ps.name);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</div><div class="line">            <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;</div><div class="line">                possiblyDeletedUpdatedSystemApps.add(ps.name);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//清理所有安装不完整的包</span></div><div class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</div><div class="line">    cleanupInstallFailedPackage(deletePkgsList.get(i));</div><div class="line">&#125;</div><div class="line"><span class="comment">//删除临时文件</span></div><div class="line">deleteTempPackageFiles();</div><div class="line"></div><div class="line"><span class="comment">//移除不相干包中的所有共享userID</span></div><div class="line">mSettings.pruneSharedUsersLPw();</div></pre></td></tr></table></figure>
<p>PMS_SYSTEM_SCAN_START阶段主要做了如下工作：</p>
<ul>
<li>首先将BOOTCLASSPATH，SYSTEMSERVERCLASSPATH这两个环境变量下的路径加入到不需要dex优化集合alreadyDexOpted中<ul>
<li>SYSTEMSERVERCLASSPATH：主要包括/system/framework目录下services.jar，ethernet-service.jar，wifi-service.jar这3个文件。</li>
<li>BOOTCLASSPATH：该环境变量内容较多，不同ROM可能有所不同，常见内容包含/system/framework目录下的framework.jar，ext.jar，core-libart.jar，telephony-common.jar，ims-common.jar，core-junit.jar等文件。</li>
</ul>
</li>
<li>获取共享库mSharedLibraries，判断是否需要dex优化，如果需要则进行dex优化，并加入到alreadyDexOpted列表中</li>
<li>添加framework-res.apk、core-libart.jar两个文件添加到已优化集合alreadyDexOpted中</li>
<li>将framework目录下，其他的apk或者jar，进行dex优化并加入已优化集合alreadyDexOpted中</li>
<li>scanDirLI(): 扫描指定目录下的apk文件，最终调用PackageParser.parseBaseApk来完成AndroidManifest.xml文件的解析，生成Application, activity,service,broadcast, provider等信息</li>
<li>删除系统不存在的包 removePackageLI</li>
<li>清理安装失败的包 cleanupInstallFailedPackage</li>
<li>删除临时文件 deleteTempPackageFiles</li>
<li>移除不相干包中的所有共享userID</li>
</ul>
<h2 id="PMS-DATA-SCAN-START"><a href="#PMS-DATA-SCAN-START" class="headerlink" title="PMS_DATA_SCAN_START"></a>PMS_DATA_SCAN_START</h2><p>BOOT_PROGRESS_PMS_DATA_SCAN_START阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</div><div class="line">      EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</div><div class="line">              SystemClock.uptimeMillis());</div><div class="line">      scanDirLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</div><div class="line">      scanDirLI(mDrmAppPrivateInstallDir, PackageParser.PARSE_FORWARD_LOCK,</div><div class="line">              scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Remove disable package settings for any updated system</div><div class="line">       * apps that were removed via an OTA. If they're not a</div><div class="line">       * previously-updated app, remove them completely.</div><div class="line">       * Otherwise, just revoke their system-level permissions.</div><div class="line">       */</div><div class="line">      <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</div><div class="line">          PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</div><div class="line">          mSettings.removeDisabledSystemPackageLPw(deletedAppName);</div><div class="line">          String msg;</div><div class="line">          <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</div><div class="line">              msg = <span class="string">"Updated system package "</span> + deletedAppName</div><div class="line">                      + <span class="string">" no longer exists; wiping its data"</span>;</div><div class="line">              removeDataDirsLI(<span class="keyword">null</span>, deletedAppName);</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              msg = <span class="string">"Updated system app + "</span> + deletedAppName</div><div class="line">                      + <span class="string">" no longer present; removing system privileges for "</span></div><div class="line">                      + deletedAppName;</div><div class="line">              deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</div><div class="line">              PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</div><div class="line">              deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</div><div class="line">          &#125;</div><div class="line">          logCriticalInfo(Log.WARN, msg);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Make sure all system apps that we expected to appear on</div><div class="line">       * the userdata partition actually showed up. If they never</div><div class="line">       * appeared, crawl back and revive the system version.</div><div class="line">       */</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</div><div class="line">          <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</div><div class="line">          <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</div><div class="line">              <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</div><div class="line">              logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</div><div class="line">                      + <span class="string">" but never showed up; reverting to system"</span>);</div><div class="line">              <span class="keyword">final</span> <span class="keyword">int</span> reparseFlags;</div><div class="line">              <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</div><div class="line">                  reparseFlags = PackageParser.PARSE_IS_SYSTEM</div><div class="line">                          | PackageParser.PARSE_IS_SYSTEM_DIR</div><div class="line">                          | PackageParser.PARSE_IS_PRIVILEGED;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</div><div class="line">                  reparseFlags = PackageParser.PARSE_IS_SYSTEM</div><div class="line">                          | PackageParser.PARSE_IS_SYSTEM_DIR;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</div><div class="line">                  reparseFlags = PackageParser.PARSE_IS_SYSTEM</div><div class="line">                          | PackageParser.PARSE_IS_SYSTEM_DIR;</div><div class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</div><div class="line">                  reparseFlags = PackageParser.PARSE_IS_SYSTEM</div><div class="line">                          | PackageParser.PARSE_IS_SYSTEM_DIR;</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</div><div class="line">                  <span class="keyword">continue</span>;</div><div class="line">              &#125;</div><div class="line">              mSettings.enableSystemPackageLPw(packageName);</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  scanPackageLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</div><div class="line">              &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</div><div class="line">                  Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></div><div class="line">                          + e.getMessage());</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  mExpectingBetter.clear();</div><div class="line">  <span class="comment">// Now that we know all of the shared libraries, update all clients to have</span></div><div class="line">  <span class="comment">// the correct library paths.</span></div><div class="line">  updateAllSharedLibrariesLPw();</div><div class="line">  <span class="keyword">for</span> (SharedUserSetting setting : mSettings.getAllSharedUsersLPw()) &#123;</div><div class="line">      <span class="comment">// <span class="doctag">NOTE:</span> We ignore potential failures here during a system scan (like</span></div><div class="line">      <span class="comment">// the rest of the commands above) because there's precious little we</span></div><div class="line">      <span class="comment">// can do about it. A settings error is reported, though.</span></div><div class="line">      adjustCpuAbisForSharedUserLPw(setting.packages, <span class="keyword">null</span> <span class="comment">/* scanned package */</span>,</div><div class="line">              <span class="keyword">false</span> <span class="comment">/* force dexopt */</span>, <span class="keyword">false</span> <span class="comment">/* defer dexopt */</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// Now that we know all the packages we are keeping,</span></div><div class="line">  <span class="comment">// read and update their last usage times.</span></div><div class="line">  mPackageUsage.readLP();</div></pre></td></tr></table></figure>
<ul>
<li>当mOnlyCore = false时，则scanDirLI()还会收集如下目录中的apk<ul>
<li>/data/app</li>
<li>/data/app-private</li>
</ul>
</li>
</ul>
<h2 id="PMS-SCAN-END"><a href="#PMS-SCAN-END" class="headerlink" title="PMS_SCAN_END"></a>PMS_SCAN_END</h2><p>BOOT_PROGRESS_PMS_SCAN_END阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</div><div class="line">        SystemClock.uptimeMillis());</div><div class="line">Slog.i(TAG, <span class="string">"Time to scan packages: "</span></div><div class="line">        + ((SystemClock.uptimeMillis()-startTime)/<span class="number">1000f</span>)</div><div class="line">        + <span class="string">" seconds"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 当sdk版本不一致时，需要更新权限</span></div><div class="line"><span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</div><div class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</div><div class="line">    Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></div><div class="line">            + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</div><div class="line">    updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</div><div class="line">&#125;</div><div class="line">updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</div><div class="line">ver.sdkVersion = mSdkVersion;</div><div class="line"></div><div class="line"><span class="comment">//当这是ota后的首次启动，正常启动则需要清除目录的缓存代码</span></div><div class="line"><span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || mFirstBoot)) &#123;</div><div class="line">    <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="keyword">true</span>)) &#123;</div><div class="line">        mSettings.applyDefaultPreferredAppsLPw(<span class="keyword">this</span>, user.id);</div><div class="line">        applyFactoryDefaultBrowserLPw(user.id);</div><div class="line">        primeDomainVerificationsLPw(user.id);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//当权限和其他默认项都完成更新，则清理相关信息</span></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</div><div class="line"><span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</div><div class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</div><div class="line">&#125;</div><div class="line">reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL, UserHandle.USER_SYSTEM,</div><div class="line">        storageFlags);</div><div class="line"></div><div class="line"><span class="comment">//当这是ota后的首次启动，正常启动则需要清除目录的缓存代码</span></div><div class="line"><span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</div><div class="line">    Slog.i(TAG, <span class="string">"Build fingerprint changed; clearing code caches"</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</div><div class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</div><div class="line">        <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</div><div class="line">            <span class="comment">// No apps are running this early, so no need to freeze</span></div><div class="line">            clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</div><div class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</div><div class="line">                            | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ver.fingerprint = Build.FINGERPRINT;</div><div class="line">&#125;</div><div class="line"></div><div class="line">checkDefaultBrowser();</div><div class="line"></div><div class="line"><span class="comment">//当权限和其他默认项都完成更新，则清理相关信息</span></div><div class="line">mExistingSystemPackages.clear();</div><div class="line">mPromoteSystemApps = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="comment">// All the changes are done during package scanning.</span></div><div class="line">ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</div><div class="line"></div><div class="line"><span class="comment">//信息写回packages.xml文件</span></div><div class="line">mSettings.writeLPr();</div></pre></td></tr></table></figure>
<ul>
<li>当sdk版本不一致时，需要更新权限</li>
<li>当这是ota后的首次启动，正常启动则需要清除目录的缓存代码</li>
<li>当权限和其他默认项都完成更新，则清理相关信息</li>
<li>信息写回packages.xml文件</li>
</ul>
<h2 id="PMS-READY"><a href="#PMS-READY" class="headerlink" title="PMS_READY"></a>PMS_READY</h2><p>BOOT_PROGRESS_PMS_READY阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</div><div class="line">            SystemClock.uptimeMillis());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!mOnlyCore) &#123;</div><div class="line">        mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</div><div class="line">        mRequiredInstallerPackage = getRequiredInstallerLPr();</div><div class="line">        mRequiredUninstallerPackage = getRequiredUninstallerLPr();</div><div class="line">        mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</div><div class="line">        mIntentFilterVerifier = <span class="keyword">new</span> IntentVerifierProxy(mContext,</div><div class="line">                mIntentFilterVerifierComponent);</div><div class="line">        mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</div><div class="line">                PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</div><div class="line">        mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</div><div class="line">                PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mRequiredVerifierPackage = <span class="keyword">null</span>;</div><div class="line">        mRequiredInstallerPackage = <span class="keyword">null</span>;</div><div class="line">        mRequiredUninstallerPackage = <span class="keyword">null</span>;</div><div class="line">        mIntentFilterVerifierComponent = <span class="keyword">null</span>;</div><div class="line">        mIntentFilterVerifier = <span class="keyword">null</span>;</div><div class="line">        mServicesSystemSharedLibraryPackageName = <span class="keyword">null</span>;</div><div class="line">        mSharedSystemSharedLibraryPackageName = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mInstallerService = <span class="keyword">new</span> PackageInstallerService(context, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ComponentName ephemeralResolverComponent = getEphemeralResolverLPr();</div><div class="line">    <span class="keyword">final</span> ComponentName ephemeralInstallerComponent = getEphemeralInstallerLPr();</div><div class="line">    <span class="comment">// both the installer and resolver must be present to enable ephemeral</span></div><div class="line">    <span class="keyword">if</span> (ephemeralInstallerComponent != <span class="keyword">null</span> &amp;&amp; ephemeralResolverComponent != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</div><div class="line">            Slog.i(TAG, <span class="string">"Ephemeral activated; resolver: "</span> + ephemeralResolverComponent</div><div class="line">                    + <span class="string">" installer:"</span> + ephemeralInstallerComponent);</div><div class="line">        &#125;</div><div class="line">        mEphemeralResolverComponent = ephemeralResolverComponent;</div><div class="line">        mEphemeralInstallerComponent = ephemeralInstallerComponent;</div><div class="line">        setUpEphemeralInstallerActivityLP(mEphemeralInstallerComponent);</div><div class="line">        mEphemeralResolverConnection =</div><div class="line">                <span class="keyword">new</span> EphemeralResolverConnection(mContext, mEphemeralResolverComponent);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</div><div class="line">            <span class="keyword">final</span> String missingComponent =</div><div class="line">                    (ephemeralResolverComponent == <span class="keyword">null</span>)</div><div class="line">                    ? (ephemeralInstallerComponent == <span class="keyword">null</span>)</div><div class="line">                            ? <span class="string">"resolver and installer"</span></div><div class="line">                            : <span class="string">"resolver"</span></div><div class="line">                    : <span class="string">"installer"</span>;</div><div class="line">            Slog.i(TAG, <span class="string">"Ephemeral deactivated; missing "</span> + missingComponent);</div><div class="line">        &#125;</div><div class="line">        mEphemeralResolverComponent = <span class="keyword">null</span>;</div><div class="line">        mEphemeralInstallerComponent = <span class="keyword">null</span>;</div><div class="line">        mEphemeralResolverConnection = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mEphemeralApplicationRegistry = <span class="keyword">new</span> EphemeralApplicationRegistry(<span class="keyword">this</span>);</div><div class="line">&#125; <span class="comment">// synchronized (mPackages)</span></div><div class="line">&#125; <span class="comment">// synchronized (mInstallLock)</span></div><div class="line"></div><div class="line"><span class="comment">// Now after opening every single application zip, make sure they</span></div><div class="line"><span class="comment">// are all flushed.  Not really needed, but keeps things nice and</span></div><div class="line"><span class="comment">// tidy.</span></div><div class="line">Runtime.getRuntime().gc();</div><div class="line"></div><div class="line"><span class="comment">// The initial scanning above does many calls into installd while</span></div><div class="line"><span class="comment">// holding the mPackages lock, but we're mostly interested in yelling</span></div><div class="line"><span class="comment">// once we have a booted system.</span></div><div class="line">mInstaller.setWarnIfHeld(mPackages);</div><div class="line"></div><div class="line"><span class="comment">// Expose private service for system components to use.</span></div><div class="line">LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</div></pre></td></tr></table></figure>
<ul>
<li>初始化PackageInstallerService</li>
<li>GC回收下内存</li>
</ul>
<h1 id="PMS构造函数-总结"><a href="#PMS构造函数-总结" class="headerlink" title="PMS构造函数 - 总结"></a>PMS构造函数 - 总结</h1><p>PMS初始化过程，分为5个阶段：</p>
<p><strong>1. PMS_START阶段：</strong></p>
<ul>
<li>创建Settings对象；</li>
<li>将6类shareUserId到mSettings；</li>
<li>初始化SystemConfig；</li>
<li>创建名为“PackageManager”的handler线程mHandlerThread;</li>
<li>创建UserManagerService多用户管理服务；</li>
<li>通过解析4大目录中的xmL文件构造共享mSharedLibraries；</li>
</ul>
<p><strong>2. PMS_SYSTEM_SCAN_START阶段：</strong></p>
<ul>
<li>mSharedLibraries共享库中的文件执行dexopt操作；</li>
<li>system/framework目录中满足条件的apk或jar文件执行dexopt操作；</li>
<li>扫描系统apk;</li>
</ul>
<p><strong>3. PMS_DATA_SCAN_START阶段：</strong></p>
<ul>
<li>扫描/data/app目录下的apk;</li>
<li>扫描/data/app-private目录下的apk;</li>
</ul>
<p><strong>4. PMS_SCAN_END阶段：</strong></p>
<ul>
<li>将上述信息写回/data/system/packages.xml;</li>
</ul>
<p><strong>5. PMS_READY阶段：</strong></p>
<ul>
<li>创建服务PackageInstallerService；</li>
</ul>
<p>到这里，大致介绍完了整个PMS构造函数的流程，基本上PMS_SCAN_END阶段我们apk就算安装完成了，那么接下来我们单独看看其中几个比较重要的模块：</p>
<ul>
<li>Settings</li>
<li>SystemConfig - readPermissions </li>
<li>scanPackageLI</li>
</ul>
<h1 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h1><p>在BOOT_PROGRESS_PMS_START阶段，我们会创建Setting对象，以及一堆的addSharedUserLPw调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mSettings = <span class="keyword">new</span> Settings(mPackages);</div><div class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</div><div class="line">    ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</div></pre></td></tr></table></figure></p>
<h2 id="创建Settings"><a href="#创建Settings" class="headerlink" title="创建Settings"></a>创建Settings</h2><blockquote>
<p>frameworks/base/services/core/java/com/android/server/pm/Settings.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">Settings(Object lock) &#123;</div><div class="line">    <span class="keyword">this</span>(Environment.getDataDirectory(), lock);</div><div class="line">&#125;</div><div class="line"></div><div class="line">Settings(File dataDir, Object lock) &#123;</div><div class="line">    mLock = lock;</div><div class="line"></div><div class="line">    mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</div><div class="line"></div><div class="line">    <span class="comment">//创建目录"data/system"</span></div><div class="line">    mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</div><div class="line">    mSystemDir.mkdirs();</div><div class="line">    FileUtils.setPermissions(mSystemDir.toString(),</div><div class="line">            FileUtils.S_IRWXU|FileUtils.S_IRWXG</div><div class="line">            |FileUtils.S_IROTH|FileUtils.S_IXOTH,</div><div class="line">            -<span class="number">1</span>, -<span class="number">1</span>);</div><div class="line">    <span class="comment">// packages.xml和packages-backup.xml为一组，用于描述系统所安装的Package信息，</span></div><div class="line">    <span class="comment">// 其中packages-backup.xml是packages.xml的备份</span></div><div class="line">    <span class="comment">// PMS写把数据写到backup文件中，信息全部写成功后在改名为非backup文件，</span></div><div class="line">    <span class="comment">// 以防止在写文件的过程中出错，导致信息丢失</span></div><div class="line">    mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.xml"</span>);</div><div class="line">    mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-backup.xml"</span>);</div><div class="line"></div><div class="line">    <span class="comment">//packages.list保存系统中存在的所有非系统自带的APK信息，即UID大于10000的apk</span></div><div class="line">    mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.list"</span>);</div><div class="line">    FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</div><div class="line"></div><div class="line">    <span class="comment">//感觉是sdcardfs相关的文件</span></div><div class="line">    <span class="keyword">final</span> File kernelDir = <span class="keyword">new</span> File(<span class="string">"/config/sdcardfs"</span>);</div><div class="line">    mKernelMappingFilename = kernelDir.exists() ? kernelDir : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Deprecated: Needed for migration</span></div><div class="line">    <span class="comment">//packages-stopped.xml用于描述系统中强行停止运行的package信息，backup也是备份文件</span></div><div class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped.xml"</span>);</div><div class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped-backup.xml"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Settings的构造函数主要用于创建”data/system”目录和一些xml文件，并配置相应的权限,其中：</p>
<ul>
<li>packages.xml 记录所有安装app的信息，当系统进行程序安装、卸载和更新等操作时，均会更新该文件。</li>
<li>packages-backup.xml 备份文件</li>
<li>packages-stopped.xml 记录被用户强行停止的应用的Package信息</li>
<li>packages-stopped-backup.xml 备份文件</li>
<li>packages.list 记录非系统自带的APK的数据信息，这些APK有变化时会更新该文件</li>
</ul>
<h2 id="Setings-readLPw"><a href="#Setings-readLPw" class="headerlink" title="Setings.readLPw"></a>Setings.readLPw</h2><p>readLPw()函数，从/data/system/packages.xml或packages-backup.xml文件中获得packages、permissions相关信息，添加到相关内存列表中。packages.xml文件记录了系统的permisssions以及每个APK的name、codePath、flags、version等信息这些信息主要通过APK的AndroidManifest.xml解析获取，解析完APK后将更新信息写入这个文件，下次开机直接从里面读取相关信息添加到内存相关结构中。当有APK升级、安装或删除时会更新这个文件。</p>
<h2 id="Settings-writeLPr"><a href="#Settings-writeLPr" class="headerlink" title="Settings.writeLPr"></a>Settings.writeLPr</h2><p>writeLPr函数，将解析出的每个APK的信息（mSetting.mPackages）保存到packages.xml和packages.list文件。packages.list记录了如下数据：pkgName, userId, debugFlag, dataPath(包的数据路径)。</p>
<h1 id="SystemConfig-readPermissions"><a href="#SystemConfig-readPermissions" class="headerlink" title="SystemConfig - readPermissions"></a>SystemConfig - readPermissions</h1><p>同样是在BOOT_PROGRESS_PMS_START阶段，我们会初始化SystemConfig去获取系统配置信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取系统配置信息</span></div><div class="line">SystemConfig systemConfig = SystemConfig.getInstance();</div><div class="line">mGlobalGids = systemConfig.getGlobalGids();</div><div class="line">mSystemPermissions = systemConfig.getSystemPermissions();</div><div class="line">mAvailableFeatures = systemConfig.getAvailableFeatures();</div></pre></td></tr></table></figure>
<h2 id="创建SystemConfig"><a href="#创建SystemConfig" class="headerlink" title="创建SystemConfig"></a>创建SystemConfig</h2><blockquote>
<p>frameworks/base/services/core/java/com/android/server/SystemConfig.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//单例模式</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SystemConfig <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (SystemConfig.class) &#123;</div><div class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</div><div class="line">            sInstance = <span class="keyword">new</span> SystemConfig();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">SystemConfig() &#123;</div><div class="line"></div><div class="line">    <span class="comment">// system/etc/目录</span></div><div class="line">    readPermissions(Environment.buildPath(</div><div class="line">            Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_ALL);</div><div class="line">    readPermissions(Environment.buildPath(</div><div class="line">            Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_ALL);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> odmPermissionFlag = ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS;</div><div class="line">    </div><div class="line">    <span class="comment">// odm/etc/目录</span></div><div class="line">    readPermissions(Environment.buildPath(</div><div class="line">            Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), odmPermissionFlag);</div><div class="line">    readPermissions(Environment.buildPath(</div><div class="line">            Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), odmPermissionFlag);</div><div class="line"></div><div class="line">    <span class="comment">// oem/etc/目录</span></div><div class="line">    readPermissions(Environment.buildPath(</div><div class="line">        Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_FEATURES);</div><div class="line">    readPermissions(Environment.buildPath(</div><div class="line">        Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_FEATURES);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码可以看出，SystemConfig是单例模式，会通过readPermissions解析指定目录下的xml文件：</p>
<ul>
<li>/system/etc/sysconfig</li>
<li>/system/etc/permissions</li>
<li>/odm/etc/sysconfig</li>
<li>/odm/etc/permissions</li>
<li>/oem/etc/sysconfig</li>
<li>/oem/etc/permissions</li>
</ul>
<p>其中比较重要的是system/etc/permissions目录，该目录文件大多来源于代码中的<code>framworks/(base or native)/data/etc</code>，这些文件的作用是表明系统支持的feature有哪些，例如是否支持蓝牙、wifi、P2P等。</p>
<h2 id="readPermissions"><a href="#readPermissions" class="headerlink" title="readPermissions"></a>readPermissions</h2><p>readPermissions会循环去读取目录下的xml文件，但是它会跳过platform.xml文件，最后再去读取platform.xml文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPermissions</span><span class="params">(File libraryDir, <span class="keyword">int</span> permissionFlag)</span> </span>&#123;</div><div class="line">    <span class="comment">//检测目录是否存在，是否可读</span></div><div class="line">    ..........</div><div class="line">    <span class="comment">// Iterate over the files in the directory and scan .xml files</span></div><div class="line">    File platformFile = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">//  循环解析xml文件</span></div><div class="line">    <span class="keyword">for</span> (File f : libraryDir.listFiles()) &#123;</div><div class="line">        <span class="comment">// 跳过，最后再解析platform.xml </span></div><div class="line">        <span class="keyword">if</span> (f.getPath().endsWith(<span class="string">"etc/permissions/platform.xml"</span>)) &#123;</div><div class="line">            platformFile = f;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 解析可读的xml文件</span></div><div class="line">        readPermissionsFromXml(f, permissionFlag);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 最后解析platform.xml文件</span></div><div class="line">    <span class="keyword">if</span> (platformFile != <span class="keyword">null</span>) &#123;</div><div class="line">        readPermissionsFromXml(platformFile, permissionFlag);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们发现读取函数最后都调用了readPermissionsFromXml()，函数readPermissionsFromXml最终会使用XMLPullParser的方式解析这些XML文件，然后把解析出来的数据结构保存到PMS中。</p>
<h3 id="android-hardware-bluetooth-xml"><a href="#android-hardware-bluetooth-xml" class="headerlink" title="android.hardware.bluetooth.xml"></a>android.hardware.bluetooth.xml</h3><p>最终会解析并且保存到PMS的<code>final ArrayMap&lt;String, FeatureInfo&gt; mAvailableFeatures</code>中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">name</span>=<span class="string">"android.hardware.bluetooth"</span> /&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="com-android-location-provider-xml"><a href="#com-android-location-provider-xml" class="headerlink" title="com.android.location.provider.xml"></a>com.android.location.provider.xml</h3><p>指明了运行一些library时，还需要加载一些java库。<br>这个最终会解析并保存到PMS的<code>final ArrayMap&lt;String, SharedLibraryEntry&gt; mSharedLibraries</code>中。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">"com.android.location.provider"</span></span></div><div class="line">            <span class="attr">file</span>=<span class="string">"/system/framework/com.android.location.provider.jar"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="platform-xml"><a href="#platform-xml" class="headerlink" title="platform.xml"></a>platform.xml</h3><p>这个文件中定义了底层GID和app层权限名字之间的对应关系，或者直接给某一个uid赋予对应的权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> &gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"sdcard_r"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"sdcard_rw"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.MODIFY_AUDIO_SETTINGS"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_SURFACE_FLINGER"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></div><div class="line">    ......</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></div></pre></td></tr></table></figure>
<p>解析<code>&lt;permission&gt;</code>标签的时候，会创建一个PermissionEntry类，他关联了gids和permission name：<br>最终PermissionEntry会放入SystemConfig的<code>final ArrayMap&lt;String, PermissionEntry&gt; mPermissions</code>变量中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionEntry</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">final</span> String name;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">int</span>[] gids;</div><div class="line">        PermissionEntry(String _name) &#123;</div><div class="line">            name = _name;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>解析<code>&lt;assign-permission&gt;</code>的时候表示把属性name中的字符串表示的权限赋予属性uid中的用户。uid和name则存入SystemConfig中的SparseArray&gt; 类型的<code>mSystemPermissions</code>变量中。</p>
<h1 id="scanPackageLI"><a href="#scanPackageLI" class="headerlink" title="scanPackageLI"></a>scanPackageLI</h1><p>scanPackageLI是比较重要的安装apk的方法，下面具体分析。</p>
<h2 id="scanDirLI"><a href="#scanDirLI" class="headerlink" title="scanDirLI"></a>scanDirLI</h2><p>scanDirLI函数会处理目录下每一个package文件：(当然不止scanDirLI最后会调用到scanPackageLI)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> File[] files = dir.listFiles();</div><div class="line">    .......</div><div class="line">    <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</div><div class="line">                &amp;&amp; !PackageInstallerService.isStageName(file.getName());</div><div class="line">        <span class="keyword">if</span> (!isPackage) &#123;</div><div class="line">            <span class="comment">// Ignore entries which are not packages</span></div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//处理目录下每一个package文件</span></div><div class="line">            scanPackageTracedLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK,</div><div class="line">                    scanFlags, currentTime, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</div><div class="line">            .........</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>scanPackageTracedLI函数最终会调用到scanPackageLI函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageTracedLI</span><span class="params">(File scanFile, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags,</span></span></div><div class="line">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user) <span class="keyword">throws</span> PackageManagerException &#123;</div><div class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"scanPackage"</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> scanPackageLI(scanFile, parseFlags, scanFlags, currentTime, user);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="scanPackageLI安装apk"><a href="#scanPackageLI安装apk" class="headerlink" title="scanPackageLI安装apk"></a>scanPackageLI安装apk</h2><p>PackageManagerService的scanPackageLI过程scanPackageLI()有3个重载的方法，参数稍有不同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 第（1）个</span></div><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></div><div class="line">        <span class="keyword">long</span> currentTime, UserHandle user)</div><div class="line"><span class="comment">// 第（2）个</span></div><div class="line"><span class="keyword">private</span> PackageParser.Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</div><div class="line"><span class="comment">// 第（3）个</span></div><div class="line"><span class="keyword">private</span> PackageParser.Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></div><div class="line">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</div></pre></td></tr></table></figure>
<p><strong>（1）scanPackageLI(File scanFile, int parseFlags,…）函数</strong></p>
<ul>
<li>实例化一个PackageParser对象，接着调用该对象的parsePackage()对APK文件进行解析。</li>
<li>实例化一个Package对象，用于保存解析出的APK信息</li>
<li>从AndroidManifest.xml文件中解析出VersionCode、VersionName、installLocation等全局属性信息，然后根据标签循环解析XML文件包含的其它组成部分，将解析出的信息添加到Package对象的相关列表中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></div><div class="line">        <span class="keyword">long</span> currentTime, UserHandle user) <span class="keyword">throws</span> PackageManagerException &#123;</div><div class="line">    <span class="comment">//创建出PackageParser对象</span></div><div class="line">    PackageParser pp = <span class="keyword">new</span> PackageParser();</div><div class="line">    ...........</div><div class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 解析package</span></div><div class="line">        pkg = pp.parsePackage(scanFile, parseFlags);</div><div class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</div><div class="line">        ..........</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        ..........</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//调用第（2）个scanPackageLI</span></div><div class="line">    <span class="keyword">return</span> scanPackageLI(pkg, scanFile, parseFlags, scanFlags, currentTime, user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后会调用第（2）个scanPackageLI去继续解析。</p>
<p><strong>（2）scanPackageLI(PackageParser.Package pkg, File scanFile,…)函数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</div><div class="line">        <span class="keyword">throws</span> PackageManagerException &#123;</div><div class="line">    </div><div class="line">    <span class="comment">//有childPackage时，第一次只执行检查的工作</span></div><div class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//当解析一个Package的AndroidManifest.xml时，如果该XML文件中使用了"package"的tag</span></div><div class="line">        <span class="comment">//那么该tag对应的package是当前XML文件对应package的childPackage</span></div><div class="line">        <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span> &amp;&amp; pkg.childPackages.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">            scanFlags |= SCAN_CHECK_ONLY;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//第二次进入，才开始实际的解析</span></div><div class="line">        scanFlags &amp;= ~SCAN_CHECK_ONLY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> PackageParser.Package scannedPkg;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// Scan the parent</span></div><div class="line">        <span class="comment">//scanFlags将决定这一次是否仅执行检查工作</span></div><div class="line">        scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags, currentTime, user);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">            PackageParser.Package childPkg = pkg.childPackages.get(i);</div><div class="line">            scanPackageLI(childPkg, policyFlags,</div><div class="line">                    scanFlags, currentTime, user);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        .........   </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//第一次检查完毕后，再次调用函数</span></div><div class="line">        <span class="keyword">return</span> scanPackageTracedLI(pkg, policyFlags, scanFlags, currentTime, user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> scannedPkg;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>（3）scanPackageLI(PackageParser.Package pkg, final int policyFlags,…)函数</strong></p>
<p>最终会走到第三个scanPackageLI函数，这个函数最后会调用scanPackageDirtyLI函数，scanPackageDirtyLI是实际解析package的函数，这个才是真正干活的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></div><div class="line">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user) <span class="keyword">throws</span> PackageManagerException &#123;</div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//实际的解析函数，很长...</span></div><div class="line">        <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, policyFlags, scanFlags,</div><div class="line">                currentTime, user);</div><div class="line">        success = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        ...........</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="scanPackageDirtyLI"><a href="#scanPackageDirtyLI" class="headerlink" title="scanPackageDirtyLI"></a>scanPackageDirtyLI</h2><p>通过上述的扫描过程，我们得到了当前apk文件对应的Package信息。不过这部分信息是存储在PackageParser中的，我们必须将这部分信息传递到PMS中。毕竟最终的目的是：<strong>让PMS能得到所有目录下Package的信息</strong>。<br>scanPackageDirtyLI函数主要就是把签名解析应用程序得到的package、provider、service、receiver和activity等信息保存在PackageManagerService相关的成员列表里。</p>
<p>比如将每个APK的receivers列表里的元素，通过mReceivers.addActivity(a, “receiver”)添加到PMS成员列表mReceivers中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> ActivityIntentResolver mReceivers = <span class="keyword">new</span> ActivityIntentResolver();`</div></pre></td></tr></table></figure>
<p>由于实际解析函数太长，粗略看下有1000来行，读者有兴趣的可以自行研究。</p>
<ul>
<li><a href="http://blog.csdn.net/column/details/13723.html?&amp;page=2" target="_blank" rel="external">http://blog.csdn.net/column/details/13723.html?&amp;page=2</a></li>
</ul>
<h1 id="开机时间分析"><a href="#开机时间分析" class="headerlink" title="开机时间分析"></a>开机时间分析</h1><p>adb shell cat /proc/bootprof/<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"> C:\Users\shun&gt;adb shell cat /proc/bootprof</div><div class="line">----------------------------------------</div><div class="line">0           BOOT PROF (unit:msec)</div><div class="line">----------------------------------------</div><div class="line">      1655        : preloader</div><div class="line">      1001        : lk</div><div class="line">       493        : lk-&gt;Kernel</div><div class="line">----------------------------------------</div><div class="line">      5156.702307 : Kernel_init_done</div><div class="line">      5171.629538 : SElinux start.</div><div class="line">     10739.699692 : SElinux end.</div><div class="line">     11496.788538 : INIT: on init start</div><div class="line">     11878.325615 : INIT:eMMC:Mount_START</div><div class="line">     12777.653384 : INIT:eMMC:Mount_END</div><div class="line">     12780.874230 : INIT:PROTECT:Mount_START</div><div class="line">     12938.042615 : INIT:PROTECT:Mount_END</div><div class="line">     14029.370538 : INIT: eng build setting</div><div class="line">     15215.342538 : BOOT_Animation:START</div><div class="line">     16618.475076 : Zygote:Preload Start</div><div class="line">     20691.658230 : Zygote:Preload 2775 classes in 4062ms</div><div class="line">     23061.424153 : Zygote:Preload 274 obtain resources in 2334ms</div><div class="line">     23110.519076 : Zygote:Preload 31 resources in 47ms</div><div class="line">     23240.816000 : Zygote:Preload End</div><div class="line">     23720.832000 : Android:SysServerInit_START</div><div class="line">     24448.175153 : Android:PackageManagerService_Start</div><div class="line">     24747.363153 : Android:PMS_scan_START</div><div class="line">     24817.216000 : Android:PMS_scan_done:/custom/framework</div><div class="line">     24947.104384 : Android:PMS_scan_done:/system/framework</div><div class="line">     25131.265384 : Android:PMS_scan_done:/system/priv-app</div><div class="line">     25533.440461 : Android:PMS_scan_done:/system/app</div><div class="line">     25540.237769 : Android:PMS_scan_done:/system/vendor/app</div><div class="line">     25542.379538 : Android:PMS_scan_done:/system/vendor/operator/app</div><div class="line">     25544.285615 : Android:PMS_scan_done:/custom/app</div><div class="line">     25551.297076 : Android:PMS_scan_data_start</div><div class="line">     25967.971076 : Android:PMS_scan_data_done:/data/app</div><div class="line">     25969.811230 : Android:PMS_scan_data_done:/data/app-private</div><div class="line">     25971.862692 : Android:PMS_scan_END</div><div class="line">     26224.410076 : Android:PMS_READY</div><div class="line">     30108.635538 : AP_Init:[service]:[com.mediatek.security]:[com.mediatek.security/.service.PermControlService]:pid:738</div><div class="line">     30548.305692 : AP_Init:[broadcast]:[com.android.settings]:[com.android.settings/.widget.SettingsAppWidgetProvider]:pid:769</div><div class="line">     31341.380923 : AP_Init:[broadcast]:[com.mediatek.engineermode]:[com.mediatek.engineermode/.wifi.WifiStateReceiver]:pid:806</div><div class="line">     31563.917923 : AP_Init:[broadcast]:[com.tvguo.app]:[com.tvguo.app/.content.TvguoStateReceiver]:pid:829</div><div class="line">     31708.206000 : AP_Init:[service]:[com.android.systemui]:[com.android.systemui/.ImageWallpaper]:pid:847</div><div class="line">     31796.008076 : AP_Init:[service]:[com.android.inputmethod.latin]:[com.android.inputmethod.latin/.LatinIME]:pid:860</div><div class="line">     31987.434923 : AP_Init:[added application]:[com.mediatek.dongle]:[com.mediatek.dongle]:pid:878:(PersistAP)</div><div class="line">     32051.271692 : AP_Init:[added application]:[com.mediatek.bluetooth]:[com.mediatek.bluetooth]:pid:891:(PersistAP)</div><div class="line">     32142.389846 : AP_Init:[activity]:[com.android.launcher3]:[com.android.launcher3/.Launcher]:pid:906</div><div class="line">     32170.530846 : Android:SysServerInit_END</div><div class="line">     32309.788000 : AP_Init:[service]:[com.android.printspooler]:[com.android.printspooler/.PrintSpoolerService]:pid:923</div><div class="line">     33967.604076 : AP_Init:[broadcast]:[com.android.contacts]:[com.android.contacts/com.mediatek.contacts.simcontact.BootCmpReceiver]:pid:972</div><div class="line">     34752.970538 : AP_Init:[content provider]:[android.process.acore]:[com.android.providers.contacts/.ContactsProvider2]:pid:1028</div><div class="line">     35486.120000 : BOOT_Animation:END</div><div class="line">---------------------------------</div></pre></td></tr></table></figure></p>
<p>我们可以从上面的信息看到PMS在开机的时候做的动作和时间分布：（因为手上只有kk的平台，所以信息不太对应）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">24747.363153 : Android:PMS_scan_START</div><div class="line">24817.216000 : Android:PMS_scan_done:/custom/framework</div><div class="line">24947.104384 : Android:PMS_scan_done:/system/framework</div><div class="line">25131.265384 : Android:PMS_scan_done:/system/priv-app</div><div class="line">25533.440461 : Android:PMS_scan_done:/system/app</div><div class="line">25540.237769 : Android:PMS_scan_done:/system/vendor/app</div><div class="line">25542.379538 : Android:PMS_scan_done:/system/vendor/operator/app</div><div class="line">25544.285615 : Android:PMS_scan_done:/custom/app</div><div class="line">25551.297076 : Android:PMS_scan_data_start</div><div class="line">25967.971076 : Android:PMS_scan_data_done:/data/app</div><div class="line">25969.811230 : Android:PMS_scan_data_done:/data/app-private</div><div class="line">25971.862692 : Android:PMS_scan_END</div><div class="line">26224.410076 : Android:PMS_READY</div></pre></td></tr></table></figure>
<p>一般app装的越多，那么开机时间就会越长。</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><ul>
<li><a href="/img/archives/packages.xml">packages.xml 文件 </a></li>
<li><a href="/img/archives/packages.list">packages.list 文件</a></li>
<li><a href="/img/archives/platform.xml">platform.xml 文件</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PMS/" rel="tag">#PMS</a>
          
            <a href="/tags/PackageManager/" rel="tag">#PackageManager</a>
          
            <a href="/tags/PackageManagerService/" rel="tag">#PackageManagerService</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/06/android-start/" rel="next" title="Android系统启动流程">
                <i class="fa fa-chevron-left"></i> Android系统启动流程
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/18/package-install/" rel="prev" title="应用程序安装流程">
                应用程序安装流程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/01/10/packagemanager/"
           data-title="PackageManagerService启动流程" data-url="https://maoao530.github.io/2017/01/10/packagemanager/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="风中老狼" />
          <p class="site-author-name" itemprop="name">风中老狼</p>
          <p class="site-description motion-element" itemprop="description">不积跬步，无以至千里；不积小流，无以成江海</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">20</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/wang-zhao-shun-43" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/maoao530" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/shun_fzll" target="_blank" title="csdn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  csdn
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#system-server启动PMS"><span class="nav-number">1.</span> <span class="nav-text">system_server启动PMS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#startBootstrapServices"><span class="nav-number">1.1.</span> <span class="nav-text">startBootstrapServices()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#startOtherServices"><span class="nav-number">1.2.</span> <span class="nav-text">startOtherServices()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PMS-main入口"><span class="nav-number">2.</span> <span class="nav-text">PMS.main入口</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PMS构造函数-分析"><span class="nav-number">3.</span> <span class="nav-text">PMS构造函数 - 分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PMS-START"><span class="nav-number">3.1.</span> <span class="nav-text">PMS_START</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PMS-SYSTEM-SCAN-START"><span class="nav-number">3.2.</span> <span class="nav-text">PMS_SYSTEM_SCAN_START</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PMS-DATA-SCAN-START"><span class="nav-number">3.3.</span> <span class="nav-text">PMS_DATA_SCAN_START</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PMS-SCAN-END"><span class="nav-number">3.4.</span> <span class="nav-text">PMS_SCAN_END</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PMS-READY"><span class="nav-number">3.5.</span> <span class="nav-text">PMS_READY</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PMS构造函数-总结"><span class="nav-number">4.</span> <span class="nav-text">PMS构造函数 - 总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Settings"><span class="nav-number">5.</span> <span class="nav-text">Settings</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建Settings"><span class="nav-number">5.1.</span> <span class="nav-text">创建Settings</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Setings-readLPw"><span class="nav-number">5.2.</span> <span class="nav-text">Setings.readLPw</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Settings-writeLPr"><span class="nav-number">5.3.</span> <span class="nav-text">Settings.writeLPr</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SystemConfig-readPermissions"><span class="nav-number">6.</span> <span class="nav-text">SystemConfig - readPermissions</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建SystemConfig"><span class="nav-number">6.1.</span> <span class="nav-text">创建SystemConfig</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#readPermissions"><span class="nav-number">6.2.</span> <span class="nav-text">readPermissions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#android-hardware-bluetooth-xml"><span class="nav-number">6.2.1.</span> <span class="nav-text">android.hardware.bluetooth.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#com-android-location-provider-xml"><span class="nav-number">6.2.2.</span> <span class="nav-text">com.android.location.provider.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#platform-xml"><span class="nav-number">6.2.3.</span> <span class="nav-text">platform.xml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#scanPackageLI"><span class="nav-number">7.</span> <span class="nav-text">scanPackageLI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#scanDirLI"><span class="nav-number">7.1.</span> <span class="nav-text">scanDirLI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#scanPackageLI安装apk"><span class="nav-number">7.2.</span> <span class="nav-text">scanPackageLI安装apk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#scanPackageDirtyLI"><span class="nav-number">7.3.</span> <span class="nav-text">scanPackageDirtyLI</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开机时间分析"><span class="nav-number">8.</span> <span class="nav-text">开机时间分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录"><span class="nav-number">9.</span> <span class="nav-text">附录</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">风中老狼</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"maoao-530"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
